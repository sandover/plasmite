#!/usr/bin/env bash
#
# Purpose: Local git pre-commit gate to keep the repo hygienic (fmt/clippy/tests) and to
#          surface an always-visible policy banner for coding agents.
# Exports: N/A (git hook entry point).
# Role: Developer/agent guardrail; complements CI/branch protection but does not replace them.
# Invariants: Fails the commit if Rust hygiene checks fail for staged Rust-relevant changes.
# Invariants: Always prints the policy banner (even when skipping Rust checks).
set -euo pipefail

print_policy_banner() {
  cat >&2 <<'BANNER'
plasmite pre-commit policy:
- Prefer small, explicit, testable changes (avoid hidden state; no env vars except secrets).
- Keep docs coherent with code changes.
- If you touched planning state, commit `.ergo/events.jsonl` periodically.
- Do not do destructive planning operations (like prune) without explicit instruction.
BANNER
}

staged_paths() {
  git diff --cached --name-only --diff-filter=ACMR
}

is_rust_relevant_change() {
  # Cargo.lock changes should trigger the gate even if no .rs files were edited.
  staged_paths | grep -Eq '(^|/)(Cargo\.(toml|lock)|build\.rs)$|\.rs$'
}

run_rust_hygiene_gate() {
  if ! command -v cargo >/dev/null 2>&1; then
    echo "error: cargo not found (required for pre-commit gate)" >&2
    return 1
  fi

  echo "pre-commit: cargo fmt --all -- --check" >&2
  cargo fmt --all -- --check

  echo "pre-commit: cargo clippy --all-targets -- -D warnings" >&2
  cargo clippy --all-targets -- -D warnings

  echo "pre-commit: cargo test -q" >&2
  cargo test -q
}

main() {
  print_policy_banner

  if is_rust_relevant_change; then
    run_rust_hygiene_gate
  else
    echo "pre-commit: no Rust-relevant staged changes; skipping cargo checks" >&2
  fi
}

main "$@"

