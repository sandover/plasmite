name: release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build-native:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux_amd64
          - os: macos-15-intel
            target: x86_64-apple-darwin
            platform: darwin_amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin_arm64

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install smoke-test tooling
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == ubuntu-* ]]; then
            sudo apt-get update
            sudo apt-get install -y pkg-config
          else
            brew install pkg-config
          fi
      - name: Build binaries
        run: cargo build --release --target ${{ matrix.target }} --bins
      - name: Build shared library with stable identity
        shell: bash
        run: |
          if [[ "${{ matrix.target }}" == *apple-darwin ]]; then
            cargo rustc --release --target ${{ matrix.target }} --lib --crate-type=cdylib -- -C link-arg=-Wl,-install_name,@rpath/libplasmite.dylib
          else
            cargo rustc --release --target ${{ matrix.target }} --lib --crate-type=cdylib -- -C link-arg=-Wl,-soname,libplasmite.so
          fi
      - name: Build static library (optional artifact)
        run: cargo rustc --release --target ${{ matrix.target }} --lib --crate-type=staticlib
      - name: Package SDK
        shell: bash
        run: |
          version="${GITHUB_REF_NAME#v}"
          ./scripts/package_release_sdk.sh "${{ matrix.target }}" "${{ matrix.platform }}" "${version}"
      - name: Smoke test packaged SDK
        shell: bash
        run: |
          version="${GITHUB_REF_NAME#v}"
          ./scripts/cross_artifact_smoke.sh "dist/plasmite_${version}_${{ matrix.platform }}.tar.gz"
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: dist/*.tar.gz
          if-no-files-found: error

  publish-crates-io:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish to crates.io
        shell: bash
        run: |
          if [ -z "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "CARGO_REGISTRY_TOKEN not set; skipping crates.io publish."
            exit 0
          fi
          cargo publish --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"

  build-python-dist:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux_amd64
            upload_sdist: true
          - os: macos-15-intel
            target: x86_64-apple-darwin
            platform: darwin_amd64
            upload_sdist: false
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin_arm64
            upload_sdist: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: astral-sh/setup-uv@v5
      - name: Build SDK artifacts for wheel bundling
        shell: bash
        run: |
          cargo build --release --target "${{ matrix.target }}" --bins
          if [[ "${{ matrix.target }}" == *apple-darwin ]]; then
            cargo rustc --release --target "${{ matrix.target }}" --lib --crate-type=cdylib -- -C link-arg=-Wl,-install_name,@rpath/libplasmite.dylib
          else
            cargo rustc --release --target "${{ matrix.target }}" --lib --crate-type=cdylib -- -C link-arg=-Wl,-soname,libplasmite.so
          fi
      - name: Build and smoke-test python wheel
        env:
          PLASMITE_SDK_DIR: ${{ github.workspace }}/target/${{ matrix.target }}/release
        run: ./scripts/python_wheel_smoke.sh
      - uses: actions/upload-artifact@v4
        with:
          name: py-dist-${{ matrix.platform }}
          path: bindings/python/dist/*.whl
          if-no-files-found: error
      - uses: actions/upload-artifact@v4
        if: matrix.upload_sdist
        with:
          name: py-sdist
          path: bindings/python/dist/*.tar.gz
          if-no-files-found: error

  build-node-dist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: cd bindings/node && npm ci
      - name: Build SDK artifacts for npm package bundling
        shell: bash
        run: |
          cargo build --release --bins
          cargo rustc --release --lib --crate-type=cdylib -- -C link-arg=-Wl,-soname,libplasmite.so
      - name: npm pack + install smoke
        env:
          PLASMITE_SDK_DIR: ${{ github.workspace }}/target/release
        run: ./scripts/node_pack_smoke.sh
      - name: Build npm publish artifact
        env:
          PLASMITE_SDK_DIR: ${{ github.workspace }}/target/release
        run: cd bindings/node && npm pack
      - uses: actions/upload-artifact@v4
        with:
          name: node-dist
          path: bindings/node/plasmite-*.tgz
          if-no-files-found: error

  publish-pypi:
    runs-on: ubuntu-latest
    needs: [build-python-dist]
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: py-dist-*
          path: py-dist
          merge-multiple: true
      - uses: actions/download-artifact@v4
        with:
          name: py-sdist
          path: py-dist
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: py-dist
          skip-existing: true

  release:
    runs-on: ubuntu-latest
    needs: [build-native]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Checksums
        shell: bash
        run: |
          cd dist
          shasum -a 256 *.tar.gz > sha256sums.txt
          cat sha256sums.txt
      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body: |
            Release ${{ github.ref_name }}

            ## Install

            ### Homebrew (macOS and Linux)
            ```bash
            brew install sandover/tap/plasmite
            ```

            ### Manual install
            Download the appropriate tarball for your platform, extract it, and install the SDK layout:
            ```bash
            tar xzf plasmite_*_<your-platform>.tar.gz
            sudo install -d /usr/local/bin /usr/local/lib /usr/local/include /usr/local/lib/pkgconfig
            sudo cp -f bin/plasmite bin/pls /usr/local/bin/
            sudo cp -f include/plasmite.h /usr/local/include/
            sudo cp -f lib/pkgconfig/plasmite.pc /usr/local/lib/pkgconfig/
            # macOS
            sudo cp -f lib/libplasmite.dylib /usr/local/lib/ 2>/dev/null || true
            # Linux
            sudo cp -f lib/libplasmite.so /usr/local/lib/ 2>/dev/null || true
            ```

            ### From source
            ```bash
            cargo install --git https://github.com/sandover/plasmite --tag ${{ github.ref_name }} plasmite
            ```
