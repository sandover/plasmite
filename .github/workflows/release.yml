name: release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build-native:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux_amd64
          - os: macos-13
            target: x86_64-apple-darwin
            platform: darwin_amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin_arm64

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.88.0
          targets: ${{ matrix.target }}
      - run: cargo build --release --target ${{ matrix.target }} --bins
      - name: Package
        shell: bash
        run: |
          release_dir=target/${{ matrix.target }}/release
          version="${GITHUB_REF_NAME#v}"
          mkdir -p dist
          tar -C "${release_dir}" -czf "dist/plasmite_${version}_${{ matrix.platform }}.tar.gz" plasmite pls
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: dist/*.tar.gz
          if-no-files-found: error

  build-cross:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-unknown-linux-gnu
            platform: linux_arm64

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.88.0
          targets: ${{ matrix.target }}
      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross
      - run: cross build --release --target ${{ matrix.target }} --bins
      - name: Package
        shell: bash
        run: |
          release_dir=target/${{ matrix.target }}/release
          version="${GITHUB_REF_NAME#v}"
          mkdir -p dist
          tar -C "${release_dir}" -czf "dist/plasmite_${version}_${{ matrix.platform }}.tar.gz" plasmite pls
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: dist/*.tar.gz
          if-no-files-found: error

  publish-crates-io:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.88.0
      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: [build-native, build-cross]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Checksums
        shell: bash
        run: |
          cd dist
          shasum -a 256 *.tar.gz > sha256sums.txt
          cat sha256sums.txt
      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body: |
            Release ${{ github.ref_name }}

            ## Install

            ### Homebrew (macOS and Linux)
            ```bash
            brew install sandover/tap/plasmite
            ```

            ### Manual install
            Download the appropriate tarball for your platform, extract it, and move the binaries to your PATH:
            ```bash
            tar xzf plasmite_*_<your-platform>.tar.gz
            sudo mv plasmite pls /usr/local/bin/
            ```

            ### From source
            ```bash
            cargo install plasmite
            ```
