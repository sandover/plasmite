# Purpose: Build and publish rollback-only Windows fallback artifacts to an existing GitHub release.
# Exports: Manual workflow `windows-preview` with release asset upload.
# Role: Emergency fallback lane for Windows delivery incidents after official channel promotion.
# Invariants: Uploads only to an existing tag/release and always emits SHA256 sidecar.
# Invariants: Artifact names are stable and include `_windows_amd64_preview` suffix.
name: windows-preview (rollback-only)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Existing release tag to attach rollback assets to (format: vX.Y.Z)."
        required: true
        type: string
      rollback_reason:
        description: "Incident/ticket reference for invoking rollback artifacts."
        required: true
        type: string
      confirm_rollback:
        description: "Must be true to acknowledge rollback-only usage."
        required: true
        type: boolean

permissions:
  contents: write

jobs:
  windows-rollback-artifact:
    runs-on: windows-latest
    steps:
      - name: Validate release target
        id: target
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [[ "${{ inputs.confirm_rollback }}" != "true" ]]; then
            echo "error: confirm_rollback must be true for rollback-only workflow usage." >&2
            exit 1
          fi

          tag="${{ inputs.release_tag }}"
          if [[ -z "$tag" || "$tag" != v* ]]; then
            echo "error: release_tag must use vX.Y.Z format, got '$tag'." >&2
            exit 1
          fi

          if ! git ls-remote --exit-code --tags "https://github.com/${GITHUB_REPOSITORY}.git" "refs/tags/${tag}" >/dev/null; then
            echo "error: tag '${tag}' does not exist on origin." >&2
            echo "hint: create/push the tag first, then rerun windows-preview." >&2
            exit 1
          fi

          if ! gh release view "$tag" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "error: GitHub release for tag '${tag}' does not exist." >&2
            echo "hint: create the release first (for example via release-publish), then rerun windows-preview." >&2
            exit 1
          fi

          version="${tag#v}"
          asset_base="plasmite_${version}_windows_amd64_preview"
          rollback_reason="${{ inputs.rollback_reason }}"
          if [[ -z "$rollback_reason" ]]; then
            echo "error: rollback_reason is required." >&2
            exit 1
          fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "asset_base=${asset_base}" >> "$GITHUB_OUTPUT"
          echo "rollback_reason=${rollback_reason}" >> "$GITHUB_OUTPUT"
          echo "::warning title=Rollback-only workflow::Using windows-preview fallback artifacts for '$rollback_reason'."

      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build Windows rollback binaries
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cargo build --release --bins
          cargo rustc --release --lib --crate-type=cdylib

      - name: Smoke test binary
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          .\target\release\plasmite.exe --version

      - name: Package rollback zip and checksum
        id: package
        shell: pwsh
        env:
          ASSET_BASE: ${{ steps.target.outputs.asset_base }}
        run: |
          $ErrorActionPreference = "Stop"
          $distDir = Join-Path (Get-Location) "dist"
          $stageDir = Join-Path $distDir "windows-preview"
          $binDir = Join-Path $stageDir "bin"
          $libDir = Join-Path $stageDir "lib"
          $includeDir = Join-Path $stageDir "include"

          Remove-Item -Recurse -Force $stageDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path $binDir -Force | Out-Null
          New-Item -ItemType Directory -Path $libDir -Force | Out-Null
          New-Item -ItemType Directory -Path $includeDir -Force | Out-Null

          $plasmiteExe = Join-Path (Get-Location) "target\release\plasmite.exe"
          $plsExe = Join-Path (Get-Location) "target\release\pls.exe"
          $dllPath = Join-Path (Get-Location) "target\release\plasmite.dll"
          $headerPath = Join-Path (Get-Location) "include\plasmite.h"

          foreach ($path in @($plasmiteExe, $plsExe, $dllPath, $headerPath)) {
            if (-not (Test-Path $path)) {
              throw "Required artifact missing: $path"
            }
          }

          Copy-Item $plasmiteExe -Destination $binDir -Force
          Copy-Item $plsExe -Destination $binDir -Force
          Copy-Item $dllPath -Destination $libDir -Force
          Copy-Item $headerPath -Destination $includeDir -Force

          New-Item -ItemType Directory -Path $distDir -Force | Out-Null
          $zipPath = Join-Path $distDir ("$env:ASSET_BASE.zip")
          $shaPath = Join-Path $distDir ("$env:ASSET_BASE.zip.sha256")
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          if (Test-Path $shaPath) { Remove-Item -Force $shaPath }

          Compress-Archive -Path (Join-Path $stageDir '*') -DestinationPath $zipPath -CompressionLevel Optimal

          $hash = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash.ToLower()
          Set-Content -Path $shaPath -Value ("$hash  " + [System.IO.Path]::GetFileName($zipPath)) -Encoding Ascii

          "zip_path=$zipPath" >> $env:GITHUB_OUTPUT
          "sha_path=$shaPath" >> $env:GITHUB_OUTPUT
          "sha256=$hash" >> $env:GITHUB_OUTPUT

          "### Windows rollback artifact" >> $env:GITHUB_STEP_SUMMARY
          "- Tag: ${{ steps.target.outputs.tag }}" >> $env:GITHUB_STEP_SUMMARY
          "- Reason: ${{ steps.target.outputs.rollback_reason }}" >> $env:GITHUB_STEP_SUMMARY
          "- Zip: $(Split-Path -Leaf $zipPath)" >> $env:GITHUB_STEP_SUMMARY
          "- SHA256: $hash" >> $env:GITHUB_STEP_SUMMARY

      - name: Upload rollback assets to release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"
          $tag = "${{ steps.target.outputs.tag }}"
          $zipPath = "${{ steps.package.outputs.zip_path }}"
          $shaPath = "${{ steps.package.outputs.sha_path }}"
          gh release upload $tag $zipPath $shaPath --clobber --repo $env:GITHUB_REPOSITORY
