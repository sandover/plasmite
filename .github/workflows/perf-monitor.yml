# Purpose: Capture periodic benchmark telemetry for trend monitoring.
# Role: Non-blocking CI signal; does not gate release or merge decisions.
# Invariants: Uses one Linux runner profile for stable canary comparisons.
# Invariants: Always uploads raw benchmark JSON artifact for offline analysis.
# Notes: Local same-host benchmark comparisons remain the release-blocking source.

name: perf-monitor

on:
  schedule:
    - cron: "30 8 * * 1"
  workflow_dispatch:

jobs:
  bench-canary:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build benchmark runner
        run: cargo build --release --example plasmite-bench
      - name: Capture benchmark sample
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .scratch/release
          ./target/release/examples/plasmite-bench \
            --messages 5000 \
            --format json > .scratch/release/bench-ci-canary.json
          jq '{ts, version, system, result_count: (.results | length)}' \
            .scratch/release/bench-ci-canary.json > .scratch/release/bench-ci-canary-summary.json
      - uses: actions/upload-artifact@v4
        with:
          name: perf-monitor-${{ github.run_id }}
          path: |
            .scratch/release/bench-ci-canary.json
            .scratch/release/bench-ci-canary-summary.json
          if-no-files-found: error
